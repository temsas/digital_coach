import logging
from services.gigachat_service import GigaChatService

logger = logging.getLogger(__name__)

class SpellChecker:
    def __init__(self, gigachat_service):
        self.gigachat = gigachat_service
        self.common_corrections = {
            "–≥–∞—Å —É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–∞—Å—É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏", 
            "–≥–æ—Å —É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–æ—É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–æ—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–∫–æ–º–ø—å—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø—å—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–ø–∞—Ä–æ–ª—å": "–ø–∞—Ä–æ–ª–∏",
            "–ø–∞—Ä–æ—å": "–ø–∞—Ä–æ–ª–∏",
            "–ø–∞—Ä–æ–ª": "–ø–∞—Ä–æ–ª–∏",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω–∞—è –ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–µ–º–µ–π–ª": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "email": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–≤–∏—Ä—É—Å": "–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–æ–≤",
            "–∞–Ω—Ç–∏–≤–∏—Ä—É—Å": "–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–æ–≤"
        }

    def correct_spelling(self, topic):
        """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ –≤ —Ç–µ–º–µ - –¢–û–õ–¨–ö–û –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –Ω–∞—à–µ–º —Å–ª–æ–≤–∞—Ä–µ
        topic_lower = topic.lower().strip()
        if topic_lower in self.common_corrections:
            corrected = self.common_corrections[topic_lower]
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if corrected.lower() != topic_lower:
                logger.info(f"üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞—Ä—å: '{topic}' -> '{corrected}'")
                return corrected, True
            else:
                return topic, False
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        return self._check_with_ai(topic)

    def _check_with_ai(self, topic):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–µ—á–∞—Ç–æ–∫ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ - –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö"""
        try:
            prompt = f"""
–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –¢–ï–ö–°–¢ –ù–ê –ù–ê–õ–ò–ß–ò–ï –û–ü–ï–ß–ê–¢–û–ö –ò –í–ï–†–ù–ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢:

–ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢: "{topic}"

–ó–ê–î–ê–ß–ê:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –û–ü–ï–ß–ê–¢–ö–ò –∏–ª–∏ –û–†–§–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò
2. –ï—Å–ª–∏ –µ—Å—Ç—å –†–ï–ê–õ–¨–ù–´–ï –æ—à–∏–±–∫–∏ - –≤–µ—Ä–Ω–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
3. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –ù–ï–¢ - –≤–µ—Ä–Ω–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. –ù–ï "–∏—Å–ø—Ä–∞–≤–ª—è–π" –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
5. –ù–ï –º–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –µ—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫
6. –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–∞–≤—ã—á–∫–∏ –∫ –æ—Ç–≤–µ—Ç—É

–û–ë–õ–ê–°–¢–¨ –ü–†–û–í–ï–†–ö–ò: 
- –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±—É–∫–≤—ã)
- –û–ø–µ—á–∞—Ç–∫–∏ (–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∏–ª–∏ –ª–∏—à–Ω–∏–µ –±—É–∫–≤—ã)
- –û—á–µ–≤–∏–¥–Ω—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

–ü–†–ò–ú–ï–†–´ –†–ï–ê–õ–¨–ù–´–• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:
- "–≥–∞—Å —É—Å–ª—É–≥–∏" ‚Üí "–≥–æ—Å—É—Å–ª—É–≥–∏"
- "–∫–æ–º–ø—é—Ç–µ—Ä" ‚Üí "–∫–æ–º–ø—å—é—Ç–µ—Ä" 
- "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç" ‚Üí "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
- "–ø–∞—Ä–æ—å" ‚Üí "–ø–∞—Ä–æ–ª–∏"
- "–±–∞–Ω–∫–æ–≤—Å–∫–∞ –∫–∞—Ä—Ç–∞" ‚Üí "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞"

–ü–†–ò–ú–ï–†–´, –ö–û–ì–î–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –ù–£–ñ–ù–û:
- "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã" ‚Üí "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- "–∫–æ–º–ø—å—é—Ç–µ—Ä" ‚Üí "–∫–æ–º–ø—å—é—Ç–µ—Ä" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç" ‚Üí "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –¢–ï–ö–°–¢ –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í, –ö–ê–í–´–ß–ï–ö –ò–õ–ò –û–ë–™–Ø–°–ù–ï–ù–ò–ô.

–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –≤–µ—Ä–Ω–∏ –µ–≥–æ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô.
"""

            response = self.gigachat.client.chat(prompt)
            corrected = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏—Ö –¥–æ–±–∞–≤–∏–ª–∞
            corrected = corrected.strip('"\'').strip()
            
            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï —Å—Ç—Ä–æ–∫–∏ (–±–µ–∑ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –∫ lower) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            was_corrected = corrected != topic
            
            if was_corrected:
                logger.info(f"üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å: '{topic}' -> '{corrected}'")
            else:
                logger.info(f"‚úÖ –¢–µ–º–∞ '{topic}' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–µ—á–∞—Ç–æ–∫")
                
            return corrected, was_corrected
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏: {e}")
            return topic, False

    def format_correction_message(self, original_topic, corrected_topic, was_corrected):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"""
        if not was_corrected:
            return ""
        
        return f"""
üí° *–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: "{corrected_topic}"*

*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å: "{original_topic}"*

---
"""