import logging
from services.gigachat_service import GigaChatService

logger = logging.getLogger(__name__)

class SpellChecker:
    def __init__(self, gigachat_service):
        self.gigachat = gigachat_service
        self.common_corrections = {
            "–≥–∞—Å —É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–∞—Å—É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏", 
            "–≥–æ—Å —É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–æ—É—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–≥–æ—Å–ª—É–≥–∏": "–≥–æ—Å—É—Å–ª—É–≥–∏",
            "–∫–æ–º–ø—å—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø—å—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø—é—Ç–µ—Ä": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∫–æ–º–ø": "–∫–æ–º–ø—å—é—Ç–µ—Ä",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
            "–ø–∞—Ä–æ–ª—å": "–ø–∞—Ä–æ–ª–∏",
            "–ø–∞—Ä–æ—å": "–ø–∞—Ä–æ–ª–∏",
            "–ø–∞—Ä–æ–ª": "–ø–∞—Ä–æ–ª–∏",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–±–∞–Ω–∫–æ–≤—Å–∫–∞—è": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "–∫–∞—Ä—Ç–∞": "–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "—ç–ª–µ–∫—Ç—Ä–æ–Ω–∞—è –ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–µ–º–µ–π–ª": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "email": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–ø–æ—á—Ç–∞": "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞",
            "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–≤–∏—Ä—É—Å": "–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–æ–≤",
            "–∞–Ω—Ç–∏–≤–∏—Ä—É—Å": "–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–æ–≤"
        }

    def correct_spelling(self, topic):
        """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ –≤ —Ç–µ–º–µ"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –Ω–∞—à–µ–º —Å–ª–æ–≤–∞—Ä–µ
        topic_lower = topic.lower().strip()
        if topic_lower in self.common_corrections:
            corrected = self.common_corrections[topic_lower]
            logger.info(f"üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞—Ä—å: '{topic}' -> '{corrected}'")
            return corrected, True
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        return self._check_with_ai(topic)

    def _check_with_ai(self, topic):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–µ—á–∞—Ç–æ–∫ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
        try:
            prompt = f"""
–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –¢–ï–ö–°–¢ –ù–ê –ù–ê–õ–ò–ß–ò–ï –û–ü–ï–ß–ê–¢–û–ö –ò –í–ï–†–ù–ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢:

–ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢: "{topic}"

–ó–ê–î–ê–ß–ê:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–ø–µ—á–∞—Ç–∫–∏ –∏–ª–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
2. –ï—Å–ª–∏ –µ—Å—Ç—å - –≤–µ—Ä–Ω–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
3. –ï—Å–ª–∏ –Ω–µ—Ç - –≤–µ—Ä–Ω–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç

–û–ë–õ–ê–°–¢–¨ –ü–†–û–í–ï–†–ö–ò: 
- –¢–µ—Ä–º–∏–Ω—ã —Ü–∏—Ñ—Ä–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏
- –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã  
- –ù–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–µ—Ä–≤–∏—Å–æ–≤
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–Ω—è—Ç–∏—è

–ü–†–ò–ú–ï–†–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:
- "–≥–∞—Å —É—Å–ª—É–≥–∏" ‚Üí "–≥–æ—Å—É—Å–ª—É–≥–∏"
- "–∫–æ–º–ø—é—Ç–µ—Ä" ‚Üí "–∫–æ–º–ø—å—é—Ç–µ—Ä" 
- "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç" ‚Üí "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
- "–ø–∞—Ä–æ—å" ‚Üí "–ø–∞—Ä–æ–ª–∏"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –¢–ï–ö–°–¢ –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í.

–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –≤–µ—Ä–Ω–∏ –µ–≥–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
"""

            response = self.gigachat.client.chat(prompt)
            corrected = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏—Ö –¥–æ–±–∞–≤–∏–ª–∞
            corrected = corrected.strip('"\'')
            
            was_corrected = corrected.lower() != topic.lower()
            
            if was_corrected:
                logger.info(f"üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å: '{topic}' -> '{corrected}'")
            else:
                logger.info(f"‚úÖ –¢–µ–º–∞ '{topic}' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–µ—á–∞—Ç–æ–∫")
                
            return corrected, was_corrected
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏: {e}")
            return topic, False

    def format_correction_message(self, original_topic, corrected_topic, was_corrected):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"""
        if not was_corrected:
            return ""
        
        return f"""
üí° *–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: "{corrected_topic}"*

*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å: "{original_topic}"*

---
"""